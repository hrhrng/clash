# Agent Loro Migration Guide

## Overview

This guide explains how to migrate the Agent from sending `node_proposal` via SSE to writing directly to the Loro CRDT document.

## Changes Required

### 1. Install Loro Python Library

```bash
cd apps/api
uv add loro
```

### 2. Initialize Loro Sync Client in Workflow

In `apps/api/src/master_clash/workflow/middleware.py` or wherever you initialize the workflow session:

```python
from master_clash.tools.loro_sync_client import LoroSyncClient
import asyncio

class VideoProductionWorkflow:
    def __init__(self, project_id: str, jwt_token: str):
        self.project_id = project_id

        # Initialize Loro sync client
        self.loro_client = LoroSyncClient(
            project_id=project_id,
            token=jwt_token,
            sync_server_url="ws://localhost:8787"  # Or from config
        )

        # Connect to sync server
        asyncio.create_task(self.loro_client.connect())

    async def cleanup(self):
        """Call this when workflow ends"""
        await self.loro_client.disconnect()
```

### 3. Replace SSE node_proposal with Loro Operations

**Before** (SSE):
```python
# In middleware.py ~line 567
if result.proposal:
    writer = get_stream_writer()
    writer({
        "action": "create_node_proposal",
        "proposal": result.proposal,
    })
```

**After** (Loro):
```python
# In middleware.py ~line 567
if result.proposal:
    # Extract node data from proposal
    node_id = result.proposal.get("id") or result.node_id
    node_type = result.proposal.get("nodeType")
    node_data = result.proposal.get("nodeData", {})
    position = node_data.get("position", {"x": 100, "y": 200})

    # Write to Loro document
    self.loro_client.add_node(node_id, {
        "id": node_id,
        "type": node_type,
        "position": position,
        "data": {
            "label": node_data.get("label", ""),
            "assetId": node_data.get("assetId"),
            "status": node_data.get("status", "idle"),
            # ... other node-specific fields
        },
        "parentId": result.proposal.get("groupId"),
    })

    # Add edges if upstream nodes specified
    upstream_ids = result.proposal.get("upstreamNodeIds", [])
    for upstream_id in upstream_ids:
        edge_id = f"e-{upstream_id}-{node_id}"
        self.loro_client.add_edge(edge_id, {
            "id": edge_id,
            "source": upstream_id,
            "target": node_id,
            "type": "default"
        })
```

### 4. Update Both create_canvas_node and create_generation_node

There are two places in `middleware.py` that emit `create_node_proposal`:

#### Location 1: `_create_canvas_node_tool()` (around line 567)

```python
# Replace lines 566-574 with:
if result.proposal:
    self._add_node_via_loro(result.proposal, result.node_id)
```

#### Location 2: `_create_generation_node_tool()` (around line 660)

```python
# Replace lines 659-666 with:
if result.proposal:
    self._add_node_via_loro(result.proposal, result.node_id)
```

### 5. Create Helper Method

Add this helper method to your workflow class:

```python
def _add_node_via_loro(self, proposal: dict, node_id: str):
    """
    Add a node and its edges to the Loro document based on a proposal.

    Args:
        proposal: Node proposal data (same format as old SSE proposal)
        node_id: Node ID (generated by backend)
    """
    # Extract data from proposal
    node_id = proposal.get("id") or node_id
    node_type = proposal.get("nodeType", "unknown")
    node_data = proposal.get("nodeData", {})

    # Determine position (use provided or calculate)
    position = node_data.get("position", {"x": 100, "y": 200})

    # Build complete node object
    node = {
        "id": node_id,
        "type": node_type,
        "position": position,
        "data": {
            "label": node_data.get("label", ""),
            **{k: v for k, v in node_data.items() if k not in ["position", "id"]}
        }
    }

    # Add parent if specified
    if proposal.get("groupId"):
        node["parentId"] = proposal["groupId"]

    # Write to Loro document
    self.loro_client.add_node(node_id, node)

    # Add edges
    upstream_ids = proposal.get("upstreamNodeIds", [])
    for upstream_id in upstream_ids:
        edge_id = f"e-{upstream_id}-{node_id}"
        self.loro_client.add_edge(edge_id, {
            "id": edge_id,
            "source": upstream_id,
            "target": node_id,
            "type": "default"
        })

    logger.info(f"[Loro] Added node {node_id} with {len(upstream_ids)} edges")
```

### 6. Remove Old Proposal Emission Code

Search for all instances of:
```python
"action": "create_node_proposal"
```

And replace with Loro operations as shown above.

## Data Mapping

### Proposal â†’ Loro Node

**Old SSE Proposal**:
```json
{
  "id": "node_image_cat",
  "type": "generative",
  "nodeType": "action-badge-image",
  "nodeData": {
    "label": "Generated Cat",
    "assetId": "asset_xyz",
    "status": "running",
    "position": {"x": 100, "y": 200}
  },
  "groupId": "group_scene1",
  "upstreamNodeIds": ["node_video_intro"]
}
```

**New Loro Node**:
```python
loro_client.add_node("node_image_cat", {
    "id": "node_image_cat",
    "type": "action-badge-image",
    "position": {"x": 100, "y": 200},
    "data": {
        "label": "Generated Cat",
        "assetId": "asset_xyz",
        "status": "running"
    },
    "parentId": "group_scene1"
})

loro_client.add_edge("e-node_video_intro-node_image_cat", {
    "id": "e-node_video_intro-node_image_cat",
    "source": "node_video_intro",
    "target": "node_image_cat",
    "type": "default"
})
```

## Benefits

1. **Single Source of Truth**: Loro document is canonical
2. **Real-time Sync**: Changes instantly visible to all clients
3. **Conflict Resolution**: CRDT automatically handles conflicts
4. **Simpler Code**: No need for SSE event handling on frontend
5. **Offline Support**: Can work offline and merge later

## Testing

1. Start sync server:
   ```bash
   cd apps/loro-sync-server
   pnpm dev
   ```

2. Run agent workflow and verify nodes appear in frontend canvas

3. Check browser console for Loro sync logs:
   ```
   [useLoroSync] Connected to sync server
   [useLoroSync] Applied update from server
   ```

4. Check agent logs for Loro operations:
   ```
   [LoroSyncClient] Added node: node_image_cat
   [LoroSyncClient] Added edge: e-node_video_intro-node_image_cat
   ```

## Rollback Plan

If issues occur, you can temporarily re-enable SSE proposals:
1. Restore the `writer({"action": "create_node_proposal", ...})` lines
2. Re-enable frontend `eventSource.addEventListener('node_proposal', ...)` in ChatbotCopilot.tsx

## Next Steps

1. [ ] Install Loro Python library
2. [ ] Initialize LoroSyncClient in workflow
3. [ ] Replace SSE emissions with Loro operations
4. [ ] Test end-to-end
5. [ ] Remove old SSE proposal code completely
6. [ ] Update documentation
